<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="ie=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="author" content="Jannis Mattheis ">
<meta name="description" content="Install CoreDNS CoreDNS is a DNS server written in Go. It features an extensive plugin system for configuring it to your needs. In my testing, CoreDNS just worked, so I didn’t try any other DNS server.
CoreDNS provides pre-compiled binaries and docker images. You can also build it from source.
For the simplicity of this tutorial, I’ll use the pre-compiled binary. As of the time of writing, the latest version is 1." />
<meta name="keywords" content="" />
<meta name="robots" content="noodp" />
<meta name="theme-color" content="#252627" />
<link rel="canonical" href="https://jmattheis.de/blog/2019/12/setup-a-forwarding-dns-sinkhole-with-dns-over-tlshttps/" />


    <title>
        
            Setup a forwarding DNS Sinkhole with DNS over TLS&amp;HTTPS :: /dev/jmattheis 
        
    </title>



<link href="https://cdnjs.cloudflare.com/ajax/libs/flag-icon-css/3.2.1/css/flag-icon.min.css" rel="stylesheet"
    type="text/css">



<link rel="stylesheet" href="/main.min.83486328ee059c7f46889fcde3b53ccc7c0f43167f2f03a87b420e9e5c30e5b7.css">




    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
    <link rel="manifest" href="/site.webmanifest">
    <link rel="mask-icon" href="/safari-pinned-tab.svg" color="#252627">
    <link rel="shortcut icon" href="/favicon.ico">
    <meta name="msapplication-TileColor" content="#252627">
    <meta name="theme-color" content="#252627">

<meta itemprop="name" content="Setup a forwarding DNS Sinkhole with DNS over TLS&amp;HTTPS">
<meta itemprop="description" content="Setup a forwarding DNS Sinkhole with DNS over TLS&amp;HTTPS">
<meta itemprop="datePublished" content="2019-12-26T00:00:00&#43;00:00" />
<meta itemprop="dateModified" content="2019-12-26T00:00:00&#43;00:00" />
<meta itemprop="wordCount" content="1162">
<meta itemprop="image" content="https://jmattheis.de/"/>



<meta itemprop="keywords" content="tutorial,dns," /><meta name="twitter:card" content="summary_large_image"/>
<meta name="twitter:image" content="https://jmattheis.de/"/>

<meta name="twitter:title" content="Setup a forwarding DNS Sinkhole with DNS over TLS&amp;HTTPS"/>
<meta name="twitter:description" content="Setup a forwarding DNS Sinkhole with DNS over TLS&amp;HTTPS"/>





    <meta property="article:published_time" content="2019-12-26 00:00:00 &#43;0000 UTC" />








    </head>

    <body class="dark-theme">
        <div class="container">
            <header class="header">
    <span class="header__inner">
        <a href="/" style="text-decoration: none;">
    <div class="logo">
            <span class="logo__text">/dev/jmattheis</span>
    </div>
</a>


        <span class="header__right">
            <nav class="menu" style="padding-right: 20px">
                <div>
                    &nbsp; <a href="mailto:contact@jmattheis.de" target="_blank" rel="noopener" title="Email"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"></path><polyline points="22,6 12,13 2,6"></polyline></svg></a> &nbsp;&nbsp; <a href="https://github.com/jmattheis" target="_blank" rel="noopener" title="Github"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22"></path></svg></a> &nbsp;&nbsp; <a href="https://stackoverflow.com/users/4244993/jmattheis" target="_blank" rel="noopener" title="Stackoverflow"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor" stroke="currentColor" stroke-width="1" stroke-linecap="round" stroke-linejoin="round"><path d="M18.986 21.865v-6.404h2.134V24H1.844v-8.539h2.13v6.404h15.012zM6.111 19.731H16.85v-2.137H6.111v2.137zm.259-4.852l10.48 2.189.451-2.07-10.478-2.187-.453 2.068zm1.359-5.056l9.705 4.53.903-1.95-9.706-4.53-.902 1.936v.014zm2.715-4.785l8.217 6.855 1.359-1.62-8.216-6.853-1.35 1.617-.01.001zM15.751 0l-1.746 1.294 6.405 8.604 1.746-1.294L15.749 0h.002z"/></svg></a> &nbsp;
                </div>
            </nav>

            <span class="theme-toggle unselectable"><svg class="theme-toggler" width="24" height="24" viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg">
  <path d="M22 41C32.4934 41 41 32.4934 41 22C41 11.5066 32.4934 3 22
  3C11.5066 3 3 11.5066 3 22C3 32.4934 11.5066 41 22 41ZM7 22C7
  13.7157 13.7157 7 22 7V37C13.7157 37 7 30.2843 7 22Z"/>
</svg>
</span>
        </span>
    </span>
</header>


            <div class="content">
                
    <main class="post">
        <article>
            

            <h1 class="post-title">
                <a href="https://jmattheis.de/blog/2019/12/setup-a-forwarding-dns-sinkhole-with-dns-over-tlshttps/">Setup a forwarding DNS Sinkhole with DNS over TLS&amp;HTTPS</a>
            </h1>
                <hr />
                <aside id="toc">
                <div class="toc-title">Table of contents</div>
                    <nav id="TableOfContents">
  <ul>
    <li><a href="#install-coredns">Install CoreDNS</a></li>
    <li><a href="#configure-coredns">Configure CoreDNS</a>
      <ul>
        <li><a href="#forward-dns">Forward DNS</a></li>
        <li><a href="#block-domains">Block Domains</a></li>
        <li><a href="#dns-over-tls-dot--dns-over-https-doh">DNS over TLS (DoT) & DNS over HTTPS (DoH)</a></li>
        <li><a href="#cache-results">Cache results</a></li>
      </ul>
    </li>
  </ul>
</nav>
                </aside>
                <hr />


            <div class="post-content">
                <h2 id="install-coredns">Install CoreDNS</h2>
<p>CoreDNS is a DNS server written in Go.
It features an extensive plugin system for configuring it to your needs.
In my testing, CoreDNS just worked, so I didn’t try any other DNS server.</p>
<p>CoreDNS provides <a href="https://github.com/coredns/coredns/releases/latest">pre-compiled binaries</a>
and <a href="https://hub.docker.com/r/coredns/coredns/">docker images</a>. 
You can also <a href="https://github.com/coredns/coredns#compilation-from-source">build it from source</a>.</p>
<p>For the simplicity of this tutorial, I’ll use the pre-compiled binary. As of the time of writing, the latest version is <code>1.6.6</code>.</p>
<p>Download the archive:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ wget https://github.com/coredns/coredns/releases/download/v1.6.6/coredns_1.6.6_linux_amd64.tgz
</code></pre></div><p>Extract the archive:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ tar -xvf coredns_1.6.6_linux_amd64.tgz
</code></pre></div><p>The archive contains an executable named <code>coredns</code>, which we will later need to start the server.</p>
<h2 id="configure-coredns">Configure CoreDNS</h2>
<p>CoreDNS will be configured via a file that can be defined via <code>-conf</code> (default: ./Corefile). We’ll go with the default file.</p>
<p>First, we configure a server block that matches anything,
because we want that server to handle all queries (whether to forward or block the domain).</p>
<p>Each server block starts with a zone and is followed by braces <code>{ .. }</code>. 
This is mostly irrelevant for us, as we only want to forward queries 
and not host a <a href="https://en.wikipedia.org/wiki/Name_server#Authoritative_name_server">Authoritative DNS server</a> (A server which has the original zone records for a domain).</p>
<p>(Comments start with <code>#</code>)</p>
<p>-&gt; File: <code>./Corefile</code></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># . matches everything</span>
<span style="color:#75715e"># :53 listen on port 53 (default DNS port)</span>
.:53 <span style="color:#f92672">{</span> <span style="color:#f92672">}</span>
</code></pre></div><p>Now, we configure our first plugins:</p>
<p>-&gt; File: <code>./Corefile</code></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">.:53 <span style="color:#f92672">{</span>
  <span style="color:#75715e"># the any plugin blocks any queries by responding with a short reply</span>
  <span style="color:#75715e"># See https://tools.ietf.org/html/rfc8482 for more information.</span>
  any

  <span style="color:#75715e"># log errors to standard out</span>
  errors

  <span style="color:#75715e"># for better verification, we add logging of all requests</span>
  log
<span style="color:#f92672">}</span>
</code></pre></div><h3 id="forward-dns">Forward DNS</h3>
<p>Next up, we configure CoreDNS to forward our queries to an existing DNS server.
I’ll use <a href="https://developers.cloudflare.com/1.1.1.1/setting-up-1.1.1.1/">cloudflare</a> but you can choose the one you trust 
(see f.ex: <a href="https://www.privacytools.io/providers/dns/">privacytools.io/providers/dns/</a>).</p>
<p>-&gt; File: <code>./Corefile</code></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">.:53 <span style="color:#f92672">{</span>
  any
  errors
  log

  <span style="color:#75715e"># forward is the plugin name</span>
  <span style="color:#75715e"># the second parameter (.) is the base domain to match . = anything</span>
  <span style="color:#75715e"># the other parameter (before the {) are the endpoints to forward to.</span>
  <span style="color:#75715e"># tls:// means that DNS over TLS should be used for the communication</span>
  <span style="color:#75715e"># Also supported are:</span>
  <span style="color:#75715e"># dns:// -&gt; normal unencrypted DNS</span>
  <span style="color:#75715e"># https:// -&gt; DNS over HTTPS</span>
  <span style="color:#75715e"># grpc:// -&gt; DNS over gRPC</span>
  forward . tls://1.1.1.1 tls://1.0.0.1 <span style="color:#f92672">{</span>

    <span style="color:#75715e"># the server name will be used in the TLS negotiation.</span>
    tls_servername cloudflare-dns.com

    <span style="color:#75715e"># the duration for checking the health of the upstream DNS server</span>
    health_check 60s

  <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>Let’s check our configuration. Start the core DNS server with:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ sudo ./coredns
</code></pre></div><p>CoreDNS requires sudo because we use port 53, you can work around this by changing this to an unused port which is over 1000.</p>
<p>With a started server, we can make a test request with dig:</p>
<pre><code class="language-dns" data-lang="dns">$ dig @localhost -p 53 google.com
; &lt;&lt;&gt;&gt; DiG 9.14.8 &lt;&lt;&gt;&gt; @localhost -p 53 google.com
; (2 servers found)
;; global options: +cmd
;; Got answer:
;; -&gt;&gt;HEADER&lt;&lt;- opcode: QUERY, status: NOERROR, id: 33196
;; flags: qr rd ra; QUERY: 1, ANSWER: 1, AUTHORITY: 0, ADDITIONAL: 1

;; OPT PSEUDOSECTION:
; EDNS: version: 0, flags:; udp: 4096
;; QUESTION SECTION:
;google.com. IN A

;; ANSWER SECTION:
google.com. 181 IN A 172.217.17.78

;; Query time: 197 msec
;; SERVER: ::1#53(::1)
;; WHEN: Wed Dec 25 12:06:34 CET 2019
;; MSG SIZE  rcvd: 65
</code></pre><p>The server works, because it returned us the IP for google.com <code>172.217.17.78</code> (it may be different for you).</p>
<h3 id="block-domains">Block Domains</h3>
<p>Blocking domains can be done in different ways. IMO, the easiest way is by using host files.
There are many online resources, for host files with hosts that serve malware or ads.
In this tutorial, we use the basic version of <a href="https://github.com/StevenBlack/hosts">github.com/StevenBlack/hosts</a>.
But first, we try out how it works.</p>
<p>(Comments start with <code>#</code>)</p>
<p>-&gt; File: <code>./hosts</code></p>
<pre><code class="language-hosts" data-lang="hosts"># the host file has a really simple format.
# it starts with an ip address followed by one or more host names.
# In this example we resolve google.com to 0.0.0.0
0.0.0.0 google.com
</code></pre><p>0.0.0.0 is mostly used for blocking the domain.
See <a href="https://github.com/StevenBlack/hosts#we-recommend-using-0000-instead-of-127001">github.com/StevenBlack/hosts</a>.</p>
<blockquote>
<p>We prefer to use 0.0.0.0, which is defined as a non-routable meta-address used to designate an invalid, unknown, or non-applicable target.</p>
<p>Using 0.0.0.0 is empirically faster, possibly because there’s no wait for a timeout resolution. It also does not interfere with a web server that may be running on the local PC.</p>
</blockquote>
<p>-&gt; File: <code>./Corefile</code></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">.:53 <span style="color:#f92672">{</span>
  any
  errors
  log

  <span style="color:#75715e"># hosts serve zone data from a hosts file</span>
  hosts ./hosts <span style="color:#f92672">{</span>
    <span style="color:#75715e"># fallthrough passes the request to the next plugin if it couldn’t</span>
    <span style="color:#75715e"># be found inside the hosts file. Without this, no domain could be</span> 
    <span style="color:#75715e"># resolved because the forward plugin will never be executed.</span>
    fallthrough
  <span style="color:#f92672">}</span>

  forward . tls://1.1.1.1 tls://1.0.0.1 <span style="color:#f92672">{</span>
    tls_servername cloudflare-dns.com
    health_check 60s
  <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
</code></pre></div><blockquote>
<p>The order of the plugins inside the Corefile doesn’t matter, 
you could add the hosts plugin after the forward plugin and it would still have the same behavior.
The ordering of the plugins is defined in <a href="https://github.com/coredns/coredns/blob/master/plugin.cfg">https://github.com/coredns/coredns/blob/master/plugin.cfg</a></p>
</blockquote>
<p>Start the core DNS server:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ sudo ./coredns
</code></pre></div><p>Check if google.com can be resolved.</p>
<pre><code class="language-dns" data-lang="dns">$ dig @localhost -p 53 google.com
[removed bloat]

;; ANSWER SECTION:
google.com. 3600 IN A 0.0.0.0

[removed bloat]
</code></pre><p>google.com resolves to <code>0.0.0.0</code> which blocks the domain.
As we do not want to block google.com but use the host file from StevenBlack/hosts,
we remove the old hosts file</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ rm hosts
</code></pre></div><p>and download the hosts file from the GitHub repository:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ wget https://github.com/StevenBlack/hosts/raw/master/hosts
</code></pre></div><p>After a restart of the CoreDNS server, some malicious domains will be blocked and google.com is available again.</p>
<h3 id="dns-over-tls-dot--dns-over-https-doh">DNS over TLS (DoT) &amp; DNS over HTTPS (DoH)</h3>
<p>For DoT/DoH to work correctly you need a domain with a valid TLS certificate,
you can get one via certibot <a href="https://certbot.eff.org/">https://certbot.eff.org/</a> or purchase one.
You also have to create an entry in your domain settings to point your domain (or a subdomain)
to the server where CoreDNS is hosted on.</p>
<p>In this tutorial we have our certificats at <code>/var/certs/full.pem</code> and <code>/var/certs/key.pem</code>.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># add tls://.:953 to listen for DoT connections</span>
<span style="color:#75715e"># add https://.:443 to listen for DoH connections</span>
.:53 tls://.:953 https://.:443 <span style="color:#f92672">{</span>

  <span style="color:#75715e"># add the TLS plugin with the certs</span>
  tls /var/certs/full.pem /var/certs/key.pem

  any
  errors
  log
  hosts ./hosts <span style="color:#f92672">{</span>
    fallthrough
  <span style="color:#f92672">}</span>
  forward . tls://1.1.1.1 tls://1.0.0.1 <span style="color:#f92672">{</span>
    tls_servername cloudflare-dns.com
    health_check 60s
  <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>Restart the CoreDNS server and now it serves DoT/DoH :D.</p>
<h4 id="use-dot-in-android">Use DoT in Android</h4>
<ul>
<li>Open Settings</li>
<li>Click on <code>Network &amp; Internet</code></li>
<li>Click on <code>Advanced</code></li>
<li>Click on <code>Private DNS</code></li>
<li>Enter your domain or subdomain inside <code>Private DNS provider hostname</code>.</li>
</ul>
<p>A log entry should appear if you open a website on your phone. I visited <code>jmattheis.de</code> and
it created this log entry:</p>
<pre><code>[INFO] [redacted-ip]:41938 - 0 “A IN jmattheis.de. tcp 128 true 65535” NOERROR qr,rd,ra 153 0.006815507s
</code></pre><h3 id="cache-results">Cache results</h3>
<p>Caching results will reduce the traffic on the upstream DNS server.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">.:53 tls://.:953 https://.:443 <span style="color:#f92672">{</span>
  tls /var/certs/full.pem /var/certs/key.pem
  any
  errors
  log
  hosts ./hosts <span style="color:#f92672">{</span>
    fallthrough
  <span style="color:#f92672">}</span>
  forward . tls://1.1.1.1 tls://1.0.0.1 <span style="color:#f92672">{</span>
    tls_servername cloudflare-dns.com
    health_check 60s
  <span style="color:#f92672">}</span>

  <span style="color:#75715e"># Cache for 60 seconds</span>
  cache <span style="color:#ae81ff">60</span>
<span style="color:#f92672">}</span>
</code></pre></div>
            </div>
        </article>

        <hr />

        <div class="post-info">
                <p>
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-tag meta-icon"><path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"></path><line x1="7" y1="7" x2="7" y2="7"></line></svg><span class="tag"><a href="https://jmattheis.de/tags/tutorial">tutorial</a></span><span class="tag"><a href="https://jmattheis.de/tags/dns">dns</a></span>
                </p>

            <p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-file-text"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg>1162</p>

            <p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-calendar"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>2019-12-26</p>
        </div>

        
            <div class="pagination">
                <div class="pagination__title">
                    <span class="pagination__title-h"></span>
                    <hr />
                </div>

                <div class="pagination__buttons">
                    

                    
                        <span class="button next">
                            <a href="https://jmattheis.de/blog/2019/08/send-notifications-to-android-via-rest-api/">
                                <span class="button__text">Send Notifications to Android via REST-API</span>
                                <span class="button__icon">→</span>
                            </a>
                        </span>
                    
                </div>
            </div>
        

        
    </main>

            </div>

            
                <footer class="footer">
    <div class="footer__inner">
        <div class="footer__content">
            <span>Made with &#10084; by Jannis Mattheis</span>
        </div>
    </div>
    <div class="footer__inner">
        <div class="footer__content">
            <span>Powered by <a href="http://gohugo.io">Hugo</a></span>
            <span><a href="https://jmattheis.de//theme-license">theme license</a></span>
        </div>
    </div>
</footer>

            
        </div>

        




<script type="text/javascript" src="/bundle.min.2d5469329143160ae2456a69c3c76dc2d0a3b212b46afe291a51bd68650ed6f8697e001dab54f1c272c77ce08092a8c55e5bb4314e0ee334aab4b927ec896638.js" integrity="sha512-LVRpMpFDFgriRWppw8dtwtCjshK0av4pGlG9aGUO1vhpfgAdq1TxwnLHfOCAkqjFXlu0MU4O4zSqtLkn7IlmOA=="></script>



    </body>
</html>
